#!/usr/bin/env python
import time
import sys
import threading
import subprocess
import shlex

from pcaspy import Driver, SimpleServer
import random

prefix = ''
pvdb = {
    'Bpm:1-P11': {},
    'Bpm:2-P11': {},
    'Bpm:3-P11': {},
    'Bpm:4-P11': {},
    'Bpm:5-P11': {},
    'Bpm:6-P11': {},
    'Bpm:7-P11': {},
    'Bpm:8-P11': {},
    'Bpm:9-P11': {},
    'Bpm:10-P11': {},
    'Bpm:11-P11': {},
    'Bpm:12-P11': {},
    'Bpm:13-P11': {},
    'Bpm:14-P11': {},
    'Bpm:15-P11': {},
    'Bpm:16-P11': {},
    'Bpm:17-P11': {},
    'Bpm:18-P11': {},
    'Bpm:19-P11': {},
    'Bpm:20-P11': {},
    'Bpm:21-P11': {},
    'Bpm:22-P11': {},
    'Bpm:23-P11': {},
    'Bpm:24-P11': {},
    'Bpm:25-P11': {},
    'Bpm:26-P11': {},
    'Bpm:27-P11': {},
    'Bpm:28-P11': {},
    'Bpm:1-X11': {},
    'Bpm:2-X11': {},
    'Bpm:3-X11': {},
    'Bpm:4-X11': {},
    'Bpm:5-X11': {},
    'Bpm:6-X11': {},
    'Bpm:7-X11': {},
    'Bpm:8-X11': {},
    'Bpm:9-X11': {},
    'Bpm:10-X11': {},
    'Bpm:11-X11': {},
    'Bpm:12-X11': {},
    'Bpm:13-X11': {},
    'Bpm:14-X11': {},
    'Bpm:15-X11': {},
    'Bpm:16-X11': {},
    'Bpm:17-X11': {},
    'Bpm:18-X11': {},
    'Bpm:19-X11': {},
    'Bpm:20-X11': {},
    'Bpm:21-X11': {},
    'Bpm:22-X11': {},
    'Bpm:23-X11': {},
    'Bpm:24-X11': {},
    'Bpm:25-X11': {},
    'Bpm:26-X11': {},
    'Bpm:27-X11': {},
    'Bpm:28-X11': {},
    'Bpm:1-Y11': {},
    'Bpm:2-Y11': {},
    'Bpm:3-Y11': {},
    'Bpm:4-Y11': {},
    'Bpm:5-Y11': {},
    'Bpm:6-Y11': {},
    'Bpm:7-Y11': {},
    'Bpm:8-Y11': {},
    'Bpm:9-Y11': {},
    'Bpm:10-Y11': {},
    'Bpm:11-Y11': {},
    'Bpm:12-Y11': {},
    'Bpm:13-Y11': {},
    'Bpm:14-Y11': {},
    'Bpm:15-Y11': {},
    'Bpm:16-Y11': {},
    'Bpm:17-Y11': {},
    'Bpm:18-Y11': {},
    'Bpm:19-Y11': {},
    'Bpm:20-Y11': {},
    'Bpm:21-Y11': {},
    'Bpm:22-Y11': {},
    'Bpm:23-Y11': {},
    'Bpm:24-Y11': {},
    'Bpm:25-Y11': {},
    'Bpm:26-Y11': {},
    'Bpm:27-Y11': {},
    'Bpm:28-Y11': {},
    'SCRF:CAV1:EPIC': {},
    'SCRF:CAV2:EPIC': {},
    'SCRF:CAV3:EPIC': {},
    'SCRF:CAV4:EPIC': {},
    'SCRF:CAV5:EPIC': {},
    'SCRF:CAV6:EPIC': {},
    'SCRF:CAV7:EPIC': {},
    'SCRF:CAV8:EPIC': {},
    'SCRF:CAV9:EPIC': {},
    'SCRF:CAV10:EPIC': {},
    'SCRF:CAV11:EPIC': {},
    'SCRF:CAV12:EPIC': {},
    'SCRF:CAV13:EPIC': {},
    'SCRF:CAV14:EPIC': {},
    'SCRF:CAV15:EPIC': {},
    'SCRF:CAV16:EPIC': {},
    'SCRF:CAV17:EPIC': {},
    'SCRF:CAV18:EPIC': {},
    'SCRF:CAV19:EPIC': {},
    'SCRF:CAV20:EPIC': {},
    'SCRF:CAV21:EPIC': {},
    'SCRF:CAV22:EPIC': {},
    'SCRF:CAV23:EPIC': {},
    'LLRF:Buncher1:Cavity_AMP': {},
    'LLRF:Buncher2:Cavity_AMP': {},
    'SCRF:CAV1:PHASE:READ': {},
    'SCRF:CAV2:PHASE:READ': {},
    'SCRF:CAV3:PHASE:READ': {},
    'SCRF:CAV4:PHASE:READ': {},
    'SCRF:CAV5:PHASE:READ': {},
    'SCRF:CAV6:PHASE:READ': {},
    'SCRF:CAV7:PHASE:READ': {},
    'SCRF:CAV8:PHASE:READ': {},
    'HWR:LLRF:2-3:rf1phase': {},
    'HWR:LLRF:2-4:rf1phase': {},
    'SCRF:CAV11:PHASE:READ': {},
    'SCRF:CAV12:PHASE:READ': {},
    'HWR:LLRF:3-1:rf1phase': {},
    'SCRF:CAV14:PHASE:READ': {},
    'HWR:LLRF:3-3:rf1phase': {},
    'SCRF:CAV16:PHASE:READ': {},
    'SCRF:CAV17:PHASE:READ': {},
    'HWR:LLRF:3-6:rf1phase': {},
    'SCRF:CAV19:PHASE:READ': {},
    'SCRF:CAV20:PHASE:READ': {},
    'SCRF:CAV21:PHASE:READ': {},
    'SCRF:CAV22:PHASE:READ': {},
    'SCRF:CAV23:PHASE:READ': {},
    'LLRF:Buncher1:Cavity_PHASE': {},
    'LLRF:Buncher2:Cavity_PHASE': {},
    'HCM1_PS:SOL_01:ISet': {},
    'HCM1_PS:SOL_02:ISet': {},
    'HCM1_PS:SOL_03:ISet': {},
    'HCM1_PS:SOL_04:ISet': {},
    'HCM1_PS:SOL_05:ISet': {},
    'HCM1_PS:SOL_06:ISet': {},
    'HCM1_PS:DCH_01:ISet': {},
    'HCM1_PS:DCH_02:ISet': {},
    'HCM1_PS:DCH_03:ISet': {},
    'HCM1_PS:DCH_04:ISet': {},
    'HCM1_PS:DCH_05:ISet': {},
    'HCM1_PS:DCH_06:ISet': {},
    'HCM1_PS:DCV_01:ISet': {},
    'HCM1_PS:DCV_02:ISet': {},
    'HCM1_PS:DCV_03:ISet': {},
    'HCM1_PS:DCV_04:ISet': {},
    'HCM1_PS:DCV_05:ISet': {},
    'HCM1_PS:DCV_06:ISet': {},
    'HCM1_PS:SOL_01:IMon': {},
    'HCM1_PS:SOL_02:IMon': {},
    'HCM1_PS:SOL_03:IMon': {},
    'HCM1_PS:SOL_04:IMon': {},
    'HCM1_PS:SOL_05:IMon': {},
    'HCM1_PS:SOL_06:IMon': {},
    'HCM1_PS:DCH_01:IMon': {},
    'HCM1_PS:DCH_02:IMon': {},
    'HCM1_PS:DCH_03:IMon': {},
    'HCM1_PS:DCH_04:IMon': {},
    'HCM1_PS:DCH_05:IMon': {},
    'HCM1_PS:DCH_06:IMon': {},
    'HCM1_PS:DCV_01:IMon': {},
    'HCM1_PS:DCV_02:IMon': {},
    'HCM1_PS:DCV_03:IMon': {},
    'HCM1_PS:DCV_04:IMon': {},
    'HCM1_PS:DCV_05:IMon': {},
    'HCM1_PS:DCV_06:IMon': {},
    'HCM2_PS:SOL_01:ISet': {},
    'HCM2_PS:SOL_02:ISet': {},
    'HCM2_PS:SOL_03:ISet': {},
    'HCM2_PS:SOL_04:ISet': {},
    'HCM2_PS:SOL_05:ISet': {},
    'HCM2_PS:SOL_06:ISet': {},
    'HCM2_PS:SOL_01:IMon': {},
    'HCM2_PS:SOL_02:IMon': {},
    'HCM2_PS:SOL_03:IMon': {},
    'HCM2_PS:SOL_04:IMon': {},
    'HCM2_PS:SOL_05:IMon': {},
    'HCM2_PS:SOL_06:IMon': {},
    'HCM2_PS:DCH_01:IMon': {},
    'HCM2_PS:DCH_02:IMon': {},
    'HCM2_PS:DCH_03:IMon': {},
    'HCM2_PS:DCH_04:IMon': {},
    'HCM2_PS:DCH_05:IMon': {},
    'HCM2_PS:DCH_06:IMon': {},
    'HCM2_PS:DCV_01:IMon': {},
    'HCM2_PS:DCV_02:IMon': {},
    'HCM2_PS:DCV_03:IMon': {},
    'HCM2_PS:DCV_04:IMon': {},
    'HCM2_PS:DCV_05:IMon': {},
    'HCM2_PS:DCV_06:IMon': {},
    'HCM3_PS:SOL_01:ISet': {},
    'HCM3_PS:SOL_02:ISet': {},
    'HCM3_PS:SOL_03:ISet': {},
    'HCM3_PS:SOL_04:ISet': {},
    'HCM3_PS:SOL_05:ISet': {},
    'HCM3_PS:SOL_06:ISet': {},
    'HCM3_PS:SOL_01:IMon': {},
    'HCM3_PS:SOL_02:IMon': {},
    'HCM3_PS:SOL_03:IMon': {},
    'HCM3_PS:SOL_04:IMon': {},
    'HCM3_PS:SOL_05:IMon': {},
    'HCM3_PS:SOL_06:IMon': {},
    'HCM3_PS:DCH_01:IMon': {},
    'HCM3_PS:DCH_02:IMon': {},
    'HCM3_PS:DCH_03:IMon': {},
    'HCM3_PS:DCH_04:IMon': {},
    'HCM3_PS:DCH_05:IMon': {},
    'HCM3_PS:DCH_06:IMon': {},
    'HCM3_PS:DCV_01:IMon': {},
    'HCM3_PS:DCV_02:IMon': {},
    'HCM3_PS:DCV_03:IMon': {},
    'HCM3_PS:DCV_04:IMon': {},
    'HCM3_PS:DCV_05:IMon': {},
    'HCM3_PS:DCV_06:IMon': {},
    'HCM4_PS:SOL_01:ISet': {},
    'HCM4_PS:SOL_02:ISet': {},
    'HCM4_PS:SOL_03:ISet': {},
    'HCM4_PS:SOL_04:ISet': {},
    'HCM4_PS:SOL_05:ISet': {},
    'HCM4_PS:SOL_01:IMon': {},
    'HCM4_PS:SOL_02:IMon': {},
    'HCM4_PS:SOL_03:IMon': {},
    'HCM4_PS:SOL_04:IMon': {},
    'HCM4_PS:SOL_05:IMon': {},
    'HCM4_PS:DCH_01:ISet': {},
    'HCM4_PS:DCH_02:ISet': {},
    'HCM4_PS:DCH_03:ISet': {},
    'HCM4_PS:DCH_04:ISet': {},
    'HCM4_PS:DCH_05:ISet': {},
    'HCM4_PS:DCV_01:ISet': {},
    'HCM4_PS:DCV_02:ISet': {},
    'HCM4_PS:DCV_03:ISet': {},
    'HCM4_PS:DCV_04:ISet': {},
    'HCM4_PS:DCV_05:ISet': {},
    'HCM4_PS:DCH_01:IMon': {},
    'HCM4_PS:DCH_02:IMon': {},
    'HCM4_PS:DCH_03:IMon': {},
    'HCM4_PS:DCH_04:IMon': {},
    'HCM4_PS:DCH_05:IMon': {},
    'HCM4_PS:DCV_01:IMon': {},
    'HCM4_PS:DCV_02:IMon': {},
    'HCM4_PS:DCV_03:IMon': {},
    'HCM4_PS:DCV_04:IMon': {},
    'HCM4_PS:DCV_05:IMon': {},
    'MEBT_PS:Q01:CurSet': {},
    'MEBT_PS:Q02:CurSet': {},
    'MEBT_PS:Q03:CurSet': {},
    'MEBT_PS:Q04:CurSet': {},
    'MEBT_PS:Q05:CurSet': {},
    'MEBT_PS:Q06:CurSet': {},
    'MEBT_PS:DCH01:CurSet': {},
    'MEBT_PS:DCH02:CurSet': {},
    'MEBT_PS:DCH03:CurSet': {},
    'MEBT_PS:DCH04:CurSet': {},
    'MEBT_PS:DCH05:CurSet': {},
    'MEBT_PS:DCH06:CurSet': {},
    'MEBT_PS:DCV01:CurSet': {},
    'MEBT_PS:DCV02:CurSet': {},
    'MEBT_PS:DCV03:CurSet': {},
    'MEBT_PS:DCV04:CurSet': {},
    'MEBT_PS:DCV05:CurSet': {},
    'MEBT_PS:DCV06:CurSet': {},
    'MEBT_PS:Q01:CurMon': {},
    'MEBT_PS:Q02:CurMon': {},
    'MEBT_PS:Q03:CurMon': {},
    'MEBT_PS:Q04:CurMon': {},
    'MEBT_PS:Q05:CurMon': {},
    'MEBT_PS:Q06:CurMon': {},
    'MEBT_PS:DCH01:CurMon': {},
    'MEBT_PS:DCH02:CurMon': {},
    'MEBT_PS:DCH03:CurMon': {},
    'MEBT_PS:DCH04:CurMon': {},
    'MEBT_PS:DCH05:CurMon': {},
    'MEBT_PS:DCH06:CurMon': {},
    'MEBT_PS:DCV01:CurMon': {},
    'MEBT_PS:DCV02:CurMon': {},
    'MEBT_PS:DCV03:CurMon': {},
    'MEBT_PS:DCV04:CurMon': {},
    'MEBT_PS:DCV05:CurMon': {},
    'MEBT_PS:DCV06:CurMon': {},
    'HEBT_PS:T0_Q-01:CurSet': {},
    'HEBT_PS:T0_Q-02:CurSet': {},
    'HEBT_PS:T0_D-01:CurSet': {},
    'HEBT_PS:T0_CH-01:CurSet': {},
    'HEBT_PS:T0_CH-02:CurSet': {},
    'HEBT_PS:T0_CV-01:CurSet': {},
    'HEBT_PS:T0_CV-02:CurSet': {},
    'HEBT_PS:T1_Q-01:CurSet': {},
    'HEBT_PS:T1_Q-02:CurSet': {},
    'HEBT_PS:T1_Q-03:CurSet': {},
    'HEBT_PS:T1_Q-04:CurSet': {},
    'HEBT_PS:T0_D-02:CurSet': {},
    'HEBT_PS:T1_CH-01:CurSet': {},
    'HEBT_PS:T1_CH-02:CurSet': {},
    'HEBT_PS:T1_CH-03:CurSet': {},
    'HEBT_PS:T1_CH-04:CurSet': {},
    'HEBT_PS:T1_CV-01:CurSet': {},
    'HEBT_PS:T1_CV-02:CurSet': {},
    'HEBT_PS:T1_CV-03:CurSet': {},
    'HEBT_PS:T1_CV-04:CurSet': {},
    'HEBT_PS:T2_CH-03:CurSet': {},
    'HEBT_PS:T2_Q-02:CurSet': {},
    'HEBT_PS:T2_Q-03:CurSet': {},
    'HEBT_PS:T0_Q-01:CurMon': {},
    'HEBT_PS:T0_Q-02:CurMon': {},
    'HEBT_PS:T0_D-01:CurMon': {},
    'HEBT_PS:T0_CH-01:CurMon': {},
    'HEBT_PS:T0_CH-02:CurMon': {},
    'HEBT_PS:T0_CV-01:CurMon': {},
    'HEBT_PS:T0_CV-02:CurMon': {},
    'HEBT_PS:T1_Q-01:CurMon': {},
    'HEBT_PS:T1_Q-02:CurMon': {},
    'HEBT_PS:T1_Q-03:CurMon': {},
    'HEBT_PS:T1_Q-04:CurMon': {},
    'HEBT_PS:T0_D-02:CurMon': {},
    'HEBT_PS:T1_CH-01:CurMon': {},
    'HEBT_PS:T1_CH-02:CurMon': {},
    'HEBT_PS:T1_CH-03:CurMon': {},
    'HEBT_PS:T1_CH-04:CurMon': {},
    'HEBT_PS:T1_CV-01:CurMon': {},
    'HEBT_PS:T1_CV-02:CurMon': {},
    'HEBT_PS:T1_CV-03:CurMon': {},
    'HEBT_PS:T1_CV-04:CurMon': {},
    'HEBT_PS:T2_CH-03:CurMon': {},
    'HEBT_PS:T2_Q-02:CurMon': {},
    'HEBT_PS:T2_Q-03:CurMon': {},
    'LEBT_BD:FC_01:In': {},
    'LEBT_BD:FC_01:Rem': {},
    'ADS:ACCT1': {},
    'ADS:ACCT2': {},
    'ADS:ACCT3': {},
    'ADS:ACCT4': {},
    'ADS:DUTYFACTOR': {},
    'LEBT_PS:SOL_01:IMon': {},
    'ADS:G2:MC': {},
    'ADS:G3:MC': {},
    'LEBT_PS:DCH_01:IMon': {},
    'LEBT_PS:DCH_02:IMon': {},
    'LEBT_PS:DCV_01:IMon': {},
    'LEBT_PS:DCV_02:IMon': {},
    'LIPS_PS:HV_01:VMon': {},
    'LIPS_PS:HV_02:VMon': {},
    'RFQ_VAC:VLV_OUT01:Open': {},
    'HWRL_VAC:FstVLV_01:Open': {},
    'HWRL_VAC:VLV_CM1IN:Open': {},
    'HWRL_VAC:VLV_CM1OUT:Open': {},
    'HWRL_VAC:VLV_CM2IN:Open': {},
    'HWRL_VAC:VLV_CM2OUT:Open': {},
    'HWRL_VAC:VLV_CM3IN:Open': {},
    'HWRL_VAC:VLV_CM3OUT:Open': {},
    'HWRL_VAC:VLV_CM4IN:Open': {},
    'HWRL_VAC:VLV_CM4OUT:Open': {},
    'HWRL_VAC:FstVLV_02:Open': {},
    'On-GV1-HEBT': {},
    'On-GV4-HEBT': {},
    'T:axis1_real_pos_r': {},
    'T:axis2_real_pos_r': {},
    'T:axis3_real_pos_r': {},
    'T:axis5_real_pos_r': {},
    'T:axis6_real_pos_r': {},
    'T:axis7_real_pos_r': {},
    'T:axis8_real_pos_r': {},
    'T:axis9_real_pos_r': {},
    'T:axis10_real_pos_r': {},
    'T:axis11_real_pos_r': {},
    'T:axis12_real_pos_r': {},
    'T:axis13_real_pos_r': {},
    'T:axis14_real_pos_r': {},
    'T:axis15_real_pos_r': {},
    'MPS_Soft:DUTYFACTOR': {},
    'LEBT_PS:CHP_01:VMon': {},
    'FC2_in': {},
    'FC2_out': {},
    'EVG1.TRIGSRC': {},
    'HWRL_CRYO:CM_01:He_02:PRES': {},
    'HWRL_CRYO:CM_02:He_02:PRES': {},
    'HWRL_CRYO:CM_03:He_02:PRES': {},
    'TAPERL_CRYO:CM_04:He_02:PRES': {},
    'EVE1.FPS1I': {},
    'MPS_Core:Timing_EVE1:Lock01': {},
    'MPS_Core:RF_LLRF11:InST': {},
    'MPS_Core:RF_LLRF12:InST': {},
    'MPS_Core:RF_LLRF21:InST': {},
    'RFQ:LLRF:NEW:Arc_Status': {},
    'RFQ:LLRF:NEW:Arc_Status2': {},
    'LIPS_PS:HV_01:VMon': {},
    'MPS_Core:BD_BLM01:InST': {},
    'MPS_Core:BD_BLM02:InST': {},
    'MPS:MEBT:TEMP:STATUS': {},
    'MPS:HEBT:TEMP:STATUS': {},
    'MPS_Core:PS_MEBT:InST': {},
    'MPS_Core:PS_CM12:InST': {},
    'MPS_Core:PS_CM3_HEBT:InST': {},
    'MPS_Core:PS_CM4_DUMP:InST': {},
    'MPS_Core:VAC_RFQ:InST': {},
    'MPS_Core:VAC_HEBT01:InST': {},
    'MPS_Core:VAC_HEBT02:InST': {},
    'MPS_Core:VAC_CM01:InST': {},
    'MPS_Core:VAC_CM02:InST': {},
    'MPS_Core:VAC_CM03:InST': {},
    'MPS_Core:VAC_CM04:InST': {},
    'LEBT_VAC:VG:Pres': {},
    'MEBT_VAC:VG:Pres': {},
    'LEBT:vLogic_FC:Close': {},
    'LEBT_ACCE:vCalc_Amm:Vol_Rd': {},
    'Silicon:RFQ:LLRF:Power1_Cavity': {},
    'MEBT_PS:CH01:Cur_Rd': {},
    'MEBT_PS:CH02:Cur_Rd': {},
    'MEBT_PS:CH03:Cur_Rd': {},
    'LEBT:vLogic_FC:Open': {},
    'LEBT:vLogic_PVV:Open': {},
    'LEBT_BI:FC:Run_Wr': {},
    'LEBT_VAC:PVV:Run_Wr': {},
    'MEBT_VAC:PVV:Run_Wr': {},
    'H_INJECT_BD:bFCSingleConstantEnable1_W': {},
    'SCR_STRG:SDG01:CH1_WIDTH': {},
    'SCR_STRG:SDG:FRQ': {},
    'TARGET_VAC:VG:Pres': {},
    'T2BPM2.X_AVERAGE_1': {},
    'T2BPM3.X_AVERAGE_1': {},
    'T2BPM2.Y_AVERAGE_1': {},
    'T2BPM3.Y_AVERAGE_1': {},
    'SS_BD:CHAN2_AVG_SUB_OST_VAL': {},
    'HEBT_BD:CHAN2_AVG_SUB_OST_VAL': {},
    'HEBT_BD:CHAN3_AVG_SUB_OST_VAL': {},
    'HEBT_BD:CHAN7_AVG_SUB_OST_VAL': {},
    'HEBT_BD:CHAN5_AVG_SUB_OST_VAL': {},
    'HEBT_BD:CHAN6_AVG_SUB_OST_VAL': {},
}


class myDriver(Driver):
    def __init__(self):
        Driver.__init__(self)

    def write(self, reason, value):
        status = True
        # take proper actions
        self.setParam(reason, value)
        if 'set' in reason.lower():
            self.setParam(reason.replace('Set', 'Mon'), value)
        self.updatePVs()

        return status

    def read(self, reason):
        if "BPM" in reason.upper() or 'BD' in reason:
            value = random.random() * 4
        else:
            value = self.getParam(reason)
        self.updatePVs()
        return value


if __name__ == '__main__':
    server = SimpleServer()
    server.createPV(prefix, pvdb)

    driver = myDriver()

    while True:
        # process CA transactions
        server.process(0.01)
